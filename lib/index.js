// Generated by CoffeeScript 1.10.0
(function() {
  var _, async, es, seneca;

  es = require('elasticsearch');

  async = require('async');

  _ = require('underscore');

  seneca = require('seneca')();

  module.exports = function(options) {
    var _addOrUpdate, _extractCourseData, _extractLessonData, _extractSlideData, _extractSlideText, _remove, esClient, indexName, pluginName;
    pluginName = 'search';
    indexName = options.index;
    esClient = null;
    _remove = function(arg, done) {
      var id, type;
      type = arg.type, id = arg.id;
      return esClient["delete"]({
        index: indexName,
        type: type,
        id: id
      }, function(err, resp) {
        console.error(err, resp);
        return done(err, {});
      });
    };
    _addOrUpdate = function(arg, done) {
      var doc, id, type;
      type = arg.type, id = arg.id, doc = arg.doc;
      return esClient.update({
        index: indexName,
        type: type,
        id: id,
        body: {
          doc: doc,
          upsert: doc
        }
      }, function(err, resp) {
        if (err != null) {
          console.error(err);
        }
        console.error(resp);
        return done(err, {});
      });
    };
    _extractCourseData = function(course) {
      return {
        title: course.title,
        description: course.description
      };
    };
    _extractLessonData = function(lesson) {
      return {
        title: lesson.title,
        description: lesson.description
      };
    };
    _extractSlideText = function(slide) {
      var mediaRegex, separator;
      separator = "\n";
      mediaRegex = /\.(png|jpg|jpgeg|avi|mp3|mp4)$/i;
      if (_.isArray(slide)) {
        return slide.map(_extractSlideText).join(separator);
      } else if (_.isObject(slide)) {
        return _.values(slide).map(_extractSlideText).join(separator);
      } else if (_.isString(slide) && !(slide.match(mediaRegex))) {
        return slide;
      } else {
        return "";
      }
    };
    _extractSlideData = function(slide) {
      return {
        data: slide,
        text: extractSlideText(slide.data)
      };
    };
    this.add({
      init: pluginName
    }, function(args, done) {
      console.log("Connecting to Elastic Search", options.host);
      esClient = new es.Client({
        host: options.host
      });
      return esClient.ping({
        requestTimeout: Infinity
      }, function(err) {
        return done(err);
      });
    });
    this.add({
      cmd: 'update',
      type: 'course'
    }, function(args, done) {
      var doc, id;
      id = args.doc._id.toString();
      doc = _extractCourseData(args.doc);
      return _addOrUpdate({
        type: 'course',
        id: id,
        doc: doc
      }, done);
    });
    this.add({
      cmd: 'update',
      type: 'lesson'
    }, (function(_this) {
      return function(args, done) {
        var doc, id, ref, tasks;
        id = args.doc._id.toString();
        doc = _extractLessonData(args.doc);
        tasks = [];
        tasks.push(function(n) {
          return _addOrUpdate({
            type: 'lesson',
            id: id,
            doc: doc
          }, n);
        });
        tasks = tasks.concat((((ref = args.doc.configuration) != null ? ref.slides : void 0) || []).map(function(slide) {
          return function(n) {
            doc = _.extend(slide, {
              _id: id + "-" + slide.name
            });
            return _this.act({
              cmd: 'update',
              type: 'slide',
              doc: doc
            }, n);
          };
        }));
        return async.series(tasks, done);
      };
    })(this));
    this.add({
      cmd: 'update',
      type: 'slide'
    }, function(args, done) {
      var doc, id;
      id = args.doc._id.toString();
      doc = _extractLessonData(args.doc);
      return _addOrUpdate({
        type: 'slide',
        id: id,
        doc: doc
      }, done);
    });
    this.add({
      cmd: 'delete'
    }, function(args, done) {
      return _remove({
        type: args.type,
        id: args.id
      }, done);
    });
    return {
      name: pluginName
    };
  };

}).call(this);
